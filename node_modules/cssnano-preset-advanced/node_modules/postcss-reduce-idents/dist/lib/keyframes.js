"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});

exports.default = function () {
    var cache = {};
    var atRules = [];
    var decls = [];

    return {
        collect(node, encoder) {
            var name = node.name,
                prop = node.prop,
                type = node.type;


            if (type === 'atrule' && /keyframes/.test(name) && RESERVED_KEYWORDS.indexOf(node.params) === -1) {
                (0, _cache2.default)(node.params, encoder, cache);
                atRules.push(node);
            }

            if (type === 'decl' && /animation/.test(prop)) {
                decls.push(node);
            }
        },

        transform() {
            var referenced = [];
            // Iterate each property and change their names
            decls.forEach(function (decl) {
                decl.value = (0, _postcssValueParser2.default)(decl.value).walk(function (node) {
                    if (node.type === 'word' && node.value in cache) {
                        if (!~referenced.indexOf(node.value)) {
                            referenced.push(node.value);
                        }
                        cache[node.value].count++;
                        node.value = cache[node.value].ident;
                    }
                }).toString();
            });

            // Iterate each at rule and change their name if references to them have been found
            atRules.forEach(function (rule) {
                var cached = cache[rule.params];
                if (cached && cached.count > 0 && !!~referenced.indexOf(rule.params)) {
                    rule.params = cached.ident;
                }
            });

            // reset cache after transform
            atRules = [];
            decls = [];
        }
    };
};

var _postcssValueParser = require("postcss-value-parser");

var _postcssValueParser2 = _interopRequireDefault(_postcssValueParser);

var _cache = require("./cache");

var _cache2 = _interopRequireDefault(_cache);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var RESERVED_KEYWORDS = ["none", "inherit", "initial", "unset"];

module.exports = exports["default"];